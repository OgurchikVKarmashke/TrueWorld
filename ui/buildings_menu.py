# ui.buildings_menu.py
from ui.ui_utils import print_header, press_enter_to_continue, loading_screen
from systems.summon_system import summon_hero
from ui.building_manager import manage_buildings
from ui.research_manager import manage_research
from ui.synthesis_room_menu import manage_synthesis
from ui.summon_room_menu import manage_summon
from ui.storage_ui import storage_menu
from ui.forge_ui import forge_menu

def buildings_menu(game_state):
    """
    –ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–¥–∞–Ω–∏—è–º–∏
    """
    building_manager = game_state["buildings"]
    tower_level = game_state["tower_level"]
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∑–¥–∞–Ω–∏—è
    building_manager.unlock_buildings(tower_level)
    
    while True:
        print_header("üèõÔ∏è –ö–æ–º–ø–ª–µ–∫—Å –∑–¥–∞–Ω–∏–π")
        print("–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è:")
        print()
        
        available_buildings = building_manager.get_available_buildings(tower_level)
        menu_items = []
        
        counter = 1
        for key, building in available_buildings.items():
            if building.built:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∑–¥–∞–Ω–∏—è
                menu_items.append((counter, key, building.name))
                status_icon = "üè†"
                if key == "storage":
                    status_icon = "üì¶"
                elif key == "forge":
                    status_icon = "‚öíÔ∏è"
                print(f"{counter}. {status_icon} {building.name}")
                counter += 1
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏—è (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å —ç—Ç–∞–∂–∏)
        if tower_level >= 1:
            menu_items.append((counter, "upgrade", "–£–ª—É—á—à–∏—Ç—å –∑–¥–∞–Ω–∏—è"))
            print(f"{counter}. üõ†Ô∏è –£–ª—É—á—à–∏—Ç—å –∑–¥–∞–Ω–∏—è")
            counter += 1
        
        print("0. ‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–æ–±–±–∏")
        print()
        
        try:
            choice = int(input("–í–∞—à –≤—ã–±–æ—Ä: "))
        except ValueError:
            press_enter_to_continue()
            continue
        
        if choice == 0:
            break
        
        # –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—É–Ω–∫—Ç
        selected = None
        for num, key, name in menu_items:
            if num == choice:
                selected = (key, name)
                break
        
        if selected:
            key, name = selected
            if key == "upgrade":
                manage_buildings(game_state)
            elif key == "summon_hall":
                manage_summon(game_state)
            elif key == "synthesis":
                manage_synthesis(game_state)
            elif key == "laboratory":
                manage_research(game_state)
            elif key == "storage":
                storage_menu(game_state)
            elif key == "forge":
                forge_menu(game_state)
            else:
                print(f"{name} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...")
                press_enter_to_continue()
        else:
            print("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!")
            press_enter_to_continue()