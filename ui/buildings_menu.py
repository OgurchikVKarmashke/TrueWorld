# buildings_menu.py
# ui.buildings_menu.py
from ui.ui_utils import print_header, press_enter_to_continue, loading_screen
from systems.summon_system import summon_hero
from ui.building_manager import manage_buildings
from ui.research_manager import manage_research
from ui.synthesis_room_menu import manage_synthesis

def buildings_menu(game_state):
    """
    –ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–¥–∞–Ω–∏—è–º–∏
    """
    building_manager = game_state["buildings"]
    tower_level = game_state["tower_level"]
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∑–¥–∞–Ω–∏—è
    building_manager.unlock_buildings(tower_level)
    
    while True:
        print_header("üèõÔ∏è –ö–æ–º–ø–ª–µ–∫—Å –∑–¥–∞–Ω–∏–π")
        print("–í—ã–±–µ—Ä–∏—Ç–µ –∑–¥–∞–Ω–∏–µ –¥–ª—è –ø–æ—Å–µ—â–µ–Ω–∏—è:")
        print()
        
        available_buildings = building_manager.get_available_buildings(tower_level)
        menu_items = []
        
        counter = 1
        for key, building in available_buildings.items():
            if building.built:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∑–¥–∞–Ω–∏—è
                menu_items.append((counter, key, building.name))
                status_icon = "üè†"
                print(f"{counter}. {status_icon} {building.name}")
                counter += 1
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏—è (–≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å —ç—Ç–∞–∂–∏)
        if tower_level >= 1:
            menu_items.append((counter, "upgrade", "–£–ª—É—á—à–∏—Ç—å –∑–¥–∞–Ω–∏—è"))
            print(f"{counter}. üõ†Ô∏è –£–ª—É—á—à–∏—Ç—å –∑–¥–∞–Ω–∏—è")
            counter += 1
        
        print("0. ‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–æ–±–±–∏")
        print()
        
        try:
            choice = int(input("–í–∞—à –≤—ã–±–æ—Ä: "))
        except ValueError:
            press_enter_to_continue()
            continue
        
        if choice == 0:
            break
        
        # –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—É–Ω–∫—Ç
        selected = None
        for num, key, name in menu_items:
            if num == choice:
                selected = (key, name)
                break
        
        if selected:
            key, name = selected
            if key == "upgrade":
                manage_buildings(game_state)
            elif key == "summon_hall":
                summon_hall(game_state)
            elif key == "synthesis":
                manage_synthesis(game_state)
            elif key == "laboratory":
                manage_research(game_state)
            else:
                print(f"{name} –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...")
                press_enter_to_continue()
        else:
            print("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!")
            press_enter_to_continue()

def summon_hall(game_state):
    """
    –ó–∞–ª –ø—Ä–∏–∑—ã–≤–∞ –≥–µ—Ä–æ–µ–≤
    """
    while True:
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏–º–∏—Ç–µ –≥–µ—Ä–æ–µ–≤
        dormitory = game_state["buildings"].get_building("dormitory")
        current_heroes = len(game_state["heroes"])
        max_heroes = dormitory.get_capacity()
        
        print_header("–ó–∞–ª –ø—Ä–∏–∑—ã–≤–∞ –≥–µ—Ä–æ–µ–≤")
        print(f"–ó–æ–ª–æ—Ç–æ: {game_state['wallet'].gold}")
        print(f"–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: {game_state['wallet'].crystals}")
        print(f"–ì–µ—Ä–æ–µ–≤: {current_heroes}/{max_heroes}")
        print()
        print("1. –ü—Ä–∏–∑—ã–≤ –∑–∞ –∑–æ–ª–æ—Ç–æ (50 –∑–æ–ª–æ—Ç–∞)")
        print("2. –ü—Ä–∏–∑—ã–≤ –∑–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)")
        print("0. –ù–∞–∑–∞–¥")
        print()
        
        try:
            choice = int(input("–í–∞—à –≤—ã–±–æ—Ä: "))
        except ValueError:
            press_enter_to_continue()
            continue
        
        if choice == 0:
            break
        elif choice == 1:
            if current_heroes >= max_heroes:
                print("–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≥–µ—Ä–æ–µ–≤!")
                print("–£–ª—É—á—à–∏—Ç–µ –û–±—â–µ–∂–∏—Ç–∏–µ, —á—Ç–æ–±—ã —É–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç")
                press_enter_to_continue()
            else:
                summon_hero(game_state)
        elif choice == 2:
            print("–ü—Ä–∏–∑—ã–≤ –∑–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –±—É–¥—É—â–µ–º!")
            press_enter_to_continue()
        else:
            print("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!")
            press_enter_to_continue()