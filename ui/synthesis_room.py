#game_data.synthesis_room.py
from ui.ui_utils import print_header, press_enter_to_continue, loading_screen
import random

def manage_synthesis(game_state):
    """
    –£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ —Å–∏–Ω—Ç–µ–∑–∞
    """
    heroes = game_state["heroes"]
    if len(heroes) < 2:
        print_header("‚öóÔ∏è –ö–û–ú–ù–ê–¢–ê –°–ò–ù–¢–ï–ó–ê")
        print("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–µ—Ä–æ–µ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ (–Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2)")
        press_enter_to_continue()
        return

    while True:
        print_header("‚öóÔ∏è –ö–û–ú–ù–ê–¢–ê –°–ò–ù–¢–ï–ó–ê")
        print("–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è –¥–ª—è —É—Å–∏–ª–µ–Ω–∏—è:")
        print("‚ïê" * 40)
        
        for i, hero in enumerate(heroes, 1):
            star_symbol = "‚òÖ" * hero.star
            print(f"{i}. {hero.name} {star_symbol} (–£—Ä. {hero.level})")
        print("0. ‚Ü©Ô∏è –ù–∞–∑–∞–¥")
        print()
        
        try:
            choice = int(input("üéØ –í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥–µ—Ä–æ—è: "))
        except ValueError:
            continue
            
        if choice == 0:
            return
        if 1 <= choice <= len(heroes):
            base_hero = heroes[choice - 1]
            break
        else:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!")
            press_enter_to_continue()
    
    # –í—ã–±–æ—Ä –≥–µ—Ä–æ–µ–≤ –¥–ª—è –∂–µ—Ä—Ç–≤–æ–ø—Ä–∏–Ω–æ—à–µ–Ω–∏—è
    sacrifices = []
    while True:
        print_header("‚öóÔ∏è –ö–û–ú–ù–ê–¢–ê –°–ò–ù–¢–ï–ó–ê")
        print(f"–û—Å–Ω–æ–≤–Ω–æ–π –≥–µ—Ä–æ–π: {base_hero.name} (–£—Ä. {base_hero.level})")
        print("–í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ–µ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):")
        print("‚ïê" * 40)
        
        available_heroes = [h for h in heroes if h != base_hero and h not in sacrifices]
        
        if not available_heroes:
            print("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥–µ—Ä–æ–µ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞!")
            press_enter_to_continue()
            break
            
        for i, hero in enumerate(available_heroes, 1):
            star_symbol = "‚òÖ" * hero.star
            print(f"{i}. {hero.name} {star_symbol} (–£—Ä. {hero.level})")
        
        print("9. ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–±–æ—Ä")
        print("0. ‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞")
        print()
        
        try:
            choice = input("üéØ –í—ã–±–æ—Ä –≥–µ—Ä–æ–µ–≤: ")
            if choice == "0":
                return
            elif choice == "9":
                break
            else:
                indices = [int(idx.strip()) for idx in choice.split(",") if idx.strip().isdigit()]
                for idx in indices:
                    if 1 <= idx <= len(available_heroes):
                        sacrifice = available_heroes[idx - 1]
                        if sacrifice not in sacrifices:
                            sacrifices.append(sacrifice)
                            print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω: {sacrifice.name}")
        except ValueError:
            continue
    
    if not sacrifices:
        print("‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω–æ –≥–µ—Ä–æ–µ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞!")
        press_enter_to_continue()
        return
    
    # –ü—Ä–æ—Ü–µ—Å—Å —Å–∏–Ω—Ç–µ–∑–∞
    print_header("‚öóÔ∏è –ü–†–û–¶–ï–°–° –°–ò–ù–¢–ï–ó–ê")
    print(f"–û—Å–Ω–æ–≤–Ω–æ–π –≥–µ—Ä–æ–π: {base_hero.name}")
    print("–ñ–µ—Ä—Ç–≤—ã:")
    for hero in sacrifices:
        print(f"   - {hero.name} (–£—Ä. {hero.level})")
    print()
    
    # –†–∞—Å—á–µ—Ç –±–æ–Ω—É—Å–æ–≤
    total_exp = sum(hero.level * 50 for hero in sacrifices)
    stat_bonus_chance = 0.1 * len(sacrifices)  # 10% –∑–∞ –∫–∞–∂–¥–æ–≥–æ –≥–µ—Ä–æ—è
    
    print(f"üìà –ü–æ–ª—É—á–µ–Ω–æ –æ–ø—ã—Ç–∞: {total_exp}")
    print(f"üé≤ –®–∞–Ω—Å —É—Å–∏–ª–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫: {stat_bonus_chance*100:.1f}%")
    print()
    
    # –ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–∞–∫ –≤–µ–∑–¥–µ
    print("1. ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–∏–Ω—Ç–µ–∑")
    print("2. ‚ùå –û—Ç–º–µ–Ω–∏—Ç—å")
    print()
    
    try:
        confirm = int(input("üéØ –í–∞—à –≤—ã–±–æ—Ä: "))
    except ValueError:
        print("‚ùå –°–∏–Ω—Ç–µ–∑ –æ—Ç–º–µ–Ω—ë–Ω")
        press_enter_to_continue()
        return
    
    if confirm != 1:
        print("‚ùå –°–∏–Ω—Ç–µ–∑ –æ—Ç–º–µ–Ω—ë–Ω")
        press_enter_to_continue()
        return
    
    loading_screen(2, "üåÄ –ü—Ä–æ—Ü–µ—Å—Å —Å–∏–Ω—Ç–µ–∑–∞")
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–ø—ã—Ç
    result = base_hero.add_experience(total_exp)
    if result:
        print(result)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–∏–ª–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
    stat_improved = False
    if random.random() < stat_bonus_chance:
        stats = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma']
        chosen_stat = random.choice(stats)
        current_value = getattr(base_hero, chosen_stat)
        setattr(base_hero, chosen_stat, current_value + 1)
        
        stat_names = {
            'strength': '–°–∏–ª–∞', 'dexterity': '–õ–æ–≤–∫–æ—Å—Ç—å', 
            'constitution': '–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å', 'intelligence': '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç',
            'wisdom': '–ú—É–¥—Ä–æ—Å—Ç—å', 'charisma': '–•–∞—Ä–∏–∑–º–∞'
        }
        
        print(f"‚ú® {base_hero.name} –ø–æ–ª—É—á–∞–µ—Ç +1 –∫ {stat_names[chosen_stat]}!")
        stat_improved = True
    
    # –£–¥–∞–ª—è–µ–º –∂–µ—Ä—Ç–≤–µ–Ω–Ω—ã—Ö –≥–µ—Ä–æ–µ–≤
    for hero in sacrifices:
        if hero in game_state["heroes"]:
            game_state["heroes"].remove(hero)
    
    print(f"‚úÖ –°–∏–Ω—Ç–µ–∑ –∑–∞–≤–µ—Ä—à—ë–Ω! –£–¥–∞–ª–µ–Ω–æ –≥–µ—Ä–æ–µ–≤: {len(sacrifices)}")
    if stat_improved:
        print("üéâ –ü–æ–ª—É—á–µ–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏!")
    
    press_enter_to_continue()