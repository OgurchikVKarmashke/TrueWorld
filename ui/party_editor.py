#party_editor.py
from ui.ui_utils import print_header, press_enter_to_continue, loading_screen

def manage_parties(game_state):
    """
    –†–µ–¥–∞–∫—Ç–æ—Ä –±–æ–µ–≤—ã—Ö –≥—Ä—É–ø–ø
    """
    from systems.party_system import PartySystem
    party_system = PartySystem(game_state)
    
    while True:
        print_header("‚öîÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ–µ–≤—ã–º–∏ –≥—Ä—É–ø–ø–∞–º–∏")
        print(f"üè∞ –¢–µ–∫—É—â–∏–π —ç—Ç–∞–∂: {game_state['tower_level']}")
        print(f"üìä –î–æ—Å—Ç—É–ø–Ω–æ –≥—Ä—É–ø–ø: {len(party_system.parties)}/{party_system.max_parties}")
        print()
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –≥—Ä—É–ø–ø—ã
        for i, (party_id, party_data) in enumerate(party_system.parties.items(), 1):
            party_heroes = party_system.get_party_heroes(party_id)
            status = "‚úÖ" if party_data["is_unlocked"] else "üîí"
            print(f"{i}. {status} {party_data['name']}")
            print(f"   üë• –ì–µ—Ä–æ–µ–≤: {len(party_heroes)}/5")
            for hero in party_heroes:
                print(f"   - {hero.name} (–£—Ä. {hero.level})")
            print()
        
        # –û–ø—Ü–∏–∏ –º–µ–Ω—é
        if len(party_system.parties) < party_system.max_parties:
            print(f"{len(party_system.parties) + 1}. üÜï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É")
        
        print("0. ‚Ü©Ô∏è –ù–∞–∑–∞–¥")
        print()
        
        try:
            choice = int(input("üéØ –í–∞—à –≤—ã–±–æ—Ä: "))
        except ValueError:
            press_enter_to_continue()
            continue
        
        if choice == 0:
            break
        elif choice <= len(party_system.parties):
            # –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –≥—Ä—É–ø–ø—ã
            party_id = list(party_system.parties.keys())[choice - 1]
            edit_party(game_state, party_system, party_id)
        elif choice == len(party_system.parties) + 1 and choice <= party_system.max_parties:
            # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã
            create_new_party(game_state, party_system)
        else:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!")
            press_enter_to_continue()

def edit_party(game_state, party_system, party_id):
    """–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥—Ä—É–ø–ø—ã"""
    while True:
        party = party_system.parties[party_id]
        party_heroes = party_system.get_party_heroes(party_id)
        available_heroes = party_system.get_available_heroes(party_id)
        
        print_header(f"‚öîÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {party['name']}")
        
        # –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫: —Ç–µ–∫—É—â–∏–µ –≥–µ—Ä–æ–∏ –≥—Ä—É–ø–ø—ã
        print("–¢–µ–∫—É—â–∏–π —Å–æ—Å—Ç–∞–≤:")
        for i, hero in enumerate(party_heroes, 1):
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–æ–ª—å –≥–µ—Ä–æ—è, –µ—Å–ª–∏ –æ–Ω –Ω–∞–∑–Ω–∞—á–µ–Ω
            role = ""
            if hasattr(game_state.get("role_system", None), 'get_hero_role'):
                hero_role = game_state["role_system"].get_hero_role(hero)
                if hero_role:
                    role = f" - {hero_role}"
            print(f"{i}. {hero.name} (–£—Ä. {hero.level}){role} - ‚ù§Ô∏è{hero.health_current}/{hero.health_max}")
        print()
        
        # –ù–∏–∂–Ω–∏–π –±–ª–æ–∫: –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–µ—Ä–æ–∏
        if available_heroes:
            print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–µ—Ä–æ–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:")
            for i, hero in enumerate(available_heroes, 1):
                print(f"{len(party_heroes)+i}. ‚ûï {hero.name} (–£—Ä. {hero.level})")
            print()
        else:
            print("‚ùå –í—Å–µ –≥–µ—Ä–æ–∏ –∑–∞–Ω—è—Ç—ã –≤ –¥—Ä—É–≥–∏—Ö –≥—Ä—É–ø–ø–∞—Ö –∏–ª–∏ –Ω–∞ —Ä–æ–ª—è—Ö")
            print()
        
        print("0. ‚Ü©Ô∏è –ù–∞–∑–∞–¥\n")
        
        try:
            choice = int(input("üéØ –í—ã–±–µ—Ä–∏—Ç–µ –≥–µ—Ä–æ—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: "))
        except ValueError:
            press_enter_to_continue()
            continue
        
        if choice == 0:
            break
        elif 1 <= choice <= len(party_heroes):
            # –£–¥–∞–ª–µ–Ω–∏–µ –≥–µ—Ä–æ—è –∏–∑ –≥—Ä—É–ø–ø—ã
            hero = party_heroes[choice - 1]
            if party_system.remove_hero_from_party(party_id, hero):
                print(f"‚ùå {hero.name} —É–¥–∞–ª–µ–Ω –∏–∑ –≥—Ä—É–ø–ø—ã")
            press_enter_to_continue()
        elif len(party_heroes) < choice <= len(party_heroes) + len(available_heroes):
            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–µ—Ä–æ—è –≤ –≥—Ä—É–ø–ø—É
            if len(party_heroes) >= 5:
                print("‚ùå –ì—Ä—É–ø–ø–∞ —É–∂–µ –ø–æ–ª–Ω–∞—è (5/5)")
                press_enter_to_continue()
                continue
                
            hero = available_heroes[choice - len(party_heroes) - 1]
            if party_system.add_hero_to_party(party_id, hero):
                print(f"‚úÖ {hero.name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É")
            press_enter_to_continue()
        else:
            print("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä!")
            press_enter_to_continue()

def create_new_party(game_state, party_system):
    """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã"""
    if not party_system.can_unlock_new_party():
        print("‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≥—Ä—É–ø–ø!")
        press_enter_to_continue()
        return
    
    print_header("üÜï –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã")
    party_name = input("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã: ").strip()
    
    if not party_name:
        print("‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!")
        press_enter_to_continue()
        return
    
    if party_system.unlock_new_party(party_name):
        loading_screen(2, "–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã")
        print(f"‚úÖ –ì—Ä—É–ø–ø–∞ '{party_name}' —Å–æ–∑–¥–∞–Ω–∞!")
    else:
        print("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã!")
    
    press_enter_to_continue()