# systems.combat_modifiers.weather.py

from systems.combat_modifiers import register_modifier
import random

class WeatherModifier:
    def __init__(self, weather_type):
        self.weather_type = weather_type
        self.modifiers = {
            "—è—Å–Ω–æ": {"accuracy": 0.0, "description": "‚òÄÔ∏è –Ø—Å–Ω–æ: –æ–±—ã—á–Ω–∞—è –ø–æ–≥–æ–¥–∞"},
            "–æ–±–ª–∞—á–Ω–æ": {"accuracy": -0.05, "description": "‚õÖ –û–±–ª–∞—á–Ω–æ: -5% —Ç–æ—á–Ω–æ—Å—Ç–∏"},
            "–¥–æ–∂–¥—å": {"accuracy": -0.2, "evasion": 0.1, "description": "üíß –î–æ–∂–¥—å: -20% —Ç–æ—á–Ω–æ—Å—Ç–∏, +10% —É–∫–ª–æ–Ω–µ–Ω–∏—è"},
            "–≥—Ä–æ–∑–∞": {"accuracy": -0.3, "stun_chance": 0.15, "description": "‚ö° –ì—Ä–æ–∑–∞: -30% —Ç–æ—á–Ω–æ—Å—Ç–∏, 15% —à–∞–Ω—Å –æ–≥–ª—É—à–µ–Ω–∏—è"},
            "—Ç—É–º–∞–Ω": {"accuracy": -0.4, "evasion": 0.2, "description": "üå´Ô∏è –¢—É–º–∞–Ω: -40% —Ç–æ—á–Ω–æ—Å—Ç–∏, +20% —É–∫–ª–æ–Ω–µ–Ω–∏—è"},
            "—Å–Ω–µ–≥": {"speed": -0.25, "freeze_chance": 0.1, "description": "‚ùÑÔ∏è –°–Ω–µ–≥: -25% —Å–∫–æ—Ä–æ—Å—Ç–∏, 10% —à–∞–Ω—Å –∑–∞–º–æ—Ä–æ–∑–∫–∏"},
            "–≤–µ—Ç–µ—Ä": {"accuracy": -0.15, "critical_chance": 0.1, "description": "üí® –í–µ—Ç–µ—Ä: -15% —Ç–æ—á–Ω–æ—Å—Ç–∏, +10% —à–∞–Ω—Å –∫—Ä–∏—Ç–∞"},
            "–∂–∞—Ä–∞": {"stamina": -0.2, "burn_chance": 0.12, "description": "üî• –ñ–∞—Ä–∞: -20% –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏, 12% —à–∞–Ω—Å –ø–æ–¥–∂–æ–≥–∞"}
        }
    
    def apply(self, combat_system):
        if self.weather_type in self.modifiers:
            mod = self.modifiers[self.weather_type]
            combat_system.weather_modifier = mod  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –±–æ—é
            return mod
        return {}
    
    def apply_weather_effect(self, attacker, target, damage):
        """–ü—Ä–∏–º–µ–Ω—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç—ã –ø–æ–≥–æ–¥—ã –∫ –∞—Ç–∞–∫–µ"""
        if not hasattr(self, 'weather_modifier'):
            return damage
        
        mod = self.weather_modifier
        
        # –®–∞–Ω—Å –ø—Ä–æ–º–∞—Ö–∞ –∏–∑-–∑–∞ –ø–æ–≥–æ–¥—ã
        if random.random() < abs(mod.get("accuracy", 0)):
            return 0  # –ü—Ä–æ–º–∞—Ö
        
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        if "stun_chance" in mod and random.random() < mod["stun_chance"]:
            target.stunned = True  # –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å stunned –∞—Ç—Ä–∏–±—É—Ç –≤ Hero/Monster
        
        if "freeze_chance" in mod and random.random() < mod["freeze_chance"]:
            target.frozen = True
        
        if "burn_chance" in mod and random.random() < mod["burn_chance"]:
            target.burning = True
        
        return damage

register_modifier("weather", WeatherModifier)