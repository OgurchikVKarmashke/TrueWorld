# systems.combat_system.py
import random
import time
from systems.hero_system import Hero
from systems.party_system import PartySystem
from game_data.monsters_data import MONSTER_BASE_STATS, BOSS_STATS, MONSTER_SPAWN_CHANCES, MONSTER_COUNT_BY_FLOOR
from game_data.bosses_data import BOSS_ABILITIES

class Monster:
    def __init__(self, name, level, monster_type="normal"):
        self.name = name
        self.level = level
        self.monster_type = monster_type
        self._calculate_stats()
        self.health_current = self.health_max
        self.is_alive = True
        self.monster_id = f"{name}_{level}_{random.randint(1000,9999)}"

    def _calculate_stats(self):
        """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –∏ —É—Ä–æ–≤–Ω—è"""
        if self.monster_type == "boss" and self.name in BOSS_STATS:
            boss_data = BOSS_STATS[self.name]
            base_stats = MONSTER_BASE_STATS.get("–û—Ä–∫", {})  # –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∫–∞ –∫–∞–∫ –±–∞–∑—É –¥–ª—è –±–æ—Å—Å–æ–≤
            
            self.health_max = int((base_stats.get("health_per_level", 10) * self.level) * boss_data["health_multiplier"])
            self.attack = int((base_stats.get("attack_per_level", 3) * self.level) * boss_data["attack_multiplier"])
            self.defense = int((base_stats.get("defense_per_level", 1) * self.level) * boss_data["defense_multiplier"])
            self.exp_value = int((base_stats.get("exp_per_level", 15) * self.level) * boss_data["exp_multiplier"])
        else:
            monster_data = MONSTER_BASE_STATS.get(self.name, {})
            self.health_max = monster_data.get("health_per_level", 8) * self.level
            self.attack = monster_data.get("attack_per_level", 2) * self.level
            self.defense = monster_data.get("defense_per_level", 1) * self.level
            self.exp_value = monster_data.get("exp_per_level", 10) * self.level

    def take_damage(self, damage):
        actual_damage = max(1, damage - self.defense)
        self.health_current -= actual_damage
        
        if self.health_current <= 0:
            self.is_alive = False
            return f"{self.name} –ø–æ–≤–µ—Ä–∂–µ–Ω!"
        
        return f"{self.name} –ø–æ–ª—É—á–∞–µ—Ç {actual_damage} —É—Ä–æ–Ω–∞. –û—Å—Ç–∞–ª–æ—Å—å {self.health_current} HP."

    def attack_target(self, target: Hero):
        damage_dealt = random.randint(self.attack // 2, self.attack)
        result = target.take_damage(damage_dealt)
        time.sleep(0.3)
        return result

    def use_special_ability(self, heroes):
        """–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (–¥–ª—è –±–æ—Å—Å–æ–≤)"""
        if self.monster_type != "boss" or self.name not in BOSS_ABILITIES:
            return None
            
        abilities = BOSS_ABILITIES[self.name]
        for ability_name, ability_data in abilities.items():
            if random.random() < ability_data["chance"]:
                return self._execute_ability(ability_name, ability_data, heroes)
        return None

    def _execute_ability(self, ability_name, ability_data, heroes):
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å"""
        if ability_name == "–û–≥–Ω–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ":
            damage = int(self.attack * ability_data["damage_multiplier"])
            results = []
            for hero in heroes:
                if hero.is_alive:
                    result = hero.take_damage(damage // 2)  # –ø–æ–ª–Ω—ã–π —É—Ä–æ–Ω –ø–æ –≤—Å–µ–º
                    results.append(f"{hero.name}: {result}")
            return f"{self.name} –∏—Å–ø–æ–ª—å–∑—É–µ—Ç {ability_name}!\n" + "\n".join(results)
        
        return f"{self.name} –∏—Å–ø–æ–ª—å–∑—É–µ—Ç {ability_name}!"

    def to_dict(self):
        return {
            'name': self.name,
            'level': self.level,
            'monster_type': self.monster_type,
            'health_max': self.health_max,
            'health_current': self.health_current,
            'attack': self.attack,
            'defense': self.defense,
            'is_alive': self.is_alive,
            'monster_id': self.monster_id
        }

    @classmethod
    def from_dict(cls, data):
        monster = cls(data['name'], data['level'], data.get('monster_type', 'normal'))
        monster.health_max = data['health_max']
        monster.health_current = data['health_current']
        monster.attack = data['attack']
        monster.defense = data['defense']
        monster.is_alive = data['is_alive']
        return monster

class Combat:
    def __init__(self, hero_party, tower_level, game_state):
        self.heroes = hero_party
        self.tower_level = tower_level
        self.game_state = game_state
        self.monsters = self._get_or_generate_monsters()
        self.combat_log = []
        self.total_exp_earned = 0

    def _get_or_generate_monsters(self):
        if self.tower_level in self.game_state["tower_monsters"]:
            monsters_data = self.game_state["tower_monsters"][self.tower_level]
            return [Monster.from_dict(data) for data in monsters_data]
        else:
            monsters = self._generate_monsters()
            self.game_state["tower_monsters"][self.tower_level] = [m.to_dict() for m in monsters]
            return monsters

    def _generate_monsters(self):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã –º–æ–Ω—Å—Ç—Ä–æ–≤"""
        if self.tower_level % 5 == 0:
            # –ë–æ—Å—Å-—ç—Ç–∞–∂
            boss_names = [name for name, data in BOSS_STATS.items() if self.tower_level >= data["min_level"]]
            if not boss_names:
                boss_names = list(BOSS_STATS.keys())
            boss_name = random.choice(boss_names)
            boss_level = self.tower_level + 2
            return [Monster(boss_name, boss_level, "boss")]
        
        else:
            # –û–±—ã—á–Ω—ã–π —ç—Ç–∞–∂
            min_count, max_count = MONSTER_COUNT_BY_FLOOR.get(self.tower_level, (1, 3))
            monster_count = random.randint(min_count, max_count)
            
            # –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø—ã –º–æ–Ω—Å—Ç—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–∂–∞
            floor_chances = {}
            for floor, chances in MONSTER_SPAWN_CHANCES.items():
                if self.tower_level <= floor:
                    floor_chances = chances
                    break
            else:
                floor_chances = MONSTER_SPAWN_CHANCES[max(MONSTER_SPAWN_CHANCES.keys())]
            
            monsters = []
            for _ in range(monster_count):
                monster_type = self._choose_monster_type(floor_chances)
                level = max(1, self.tower_level + random.randint(-1, 1))
                monsters.append(Monster(monster_type, level))
            
            return monsters

    def _choose_monster_type(self, chances_dict):
        total = sum(chances_dict.values())
        r = random.randint(1, total)
        current = 0
        for monster_type, chance in chances_dict.items():
            current += chance
            if r <= current:
                return monster_type
        return list(chances_dict.keys())[0]

    def start_combat(self):
        """–ù–∞—á–∏–Ω–∞–µ–º —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–æ–π"""
        battle_intro = [
            "=" * 50,
            f"–ë–ê–®–ù–Ø –ò–°–ü–´–¢–ê–ù–ò–ô - –≠–¢–ê–ñ {self.tower_level}",
            "=" * 50
        ]
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏–ª—ã —Å—Ç–æ—Ä–æ–Ω
        hero_power = sum(h.attack + h.defense for h in self.heroes if h.is_alive)
        monster_power = sum(m.attack + m.defense for m in self.monsters if m.is_alive)
        
        battle_intro.extend([
            f"–°–∏–ª–∞ –æ—Ç—Ä—è–¥–∞: {hero_power}",
            f"–°–∏–ª–∞ –º–æ–Ω—Å—Ç—Ä–æ–≤: {monster_power}",
            "=" * 50
        ])
        
        for monster in self.monsters:
            battle_intro.append(f"- {monster.name} (–£—Ä. {monster.level}) | ‚ù§Ô∏è{monster.health_max} ‚öîÔ∏è{monster.attack} üõ°Ô∏è{monster.defense}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤–≤–æ–¥–Ω—É—é —á–∞—Å—Ç—å –≤ –ª–æ–≥
        self.combat_log.extend(battle_intro)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–≤–æ–¥–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        for line in battle_intro:
            print(line)
        
        time.sleep(1.5)  # –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –±–æ—è
        
        round_number = 1
        
        while any(h.is_alive for h in self.heroes) and any(m.is_alive for m in self.monsters):
            round_header = f"\n--- –†–ê–£–ù–î {round_number} ---"
            print(round_header)
            self.combat_log.append(round_header)
            time.sleep(0.6)  # –ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è –ø–∞—É–∑–∞
            
            # –•–æ–¥ –≥–µ—Ä–æ–µ–≤
            for hero in self.heroes:
                if hero.is_alive and any(m.is_alive for m in self.monsters):
                    alive_monsters = [m for m in self.monsters if m.is_alive]
                    target = random.choice(alive_monsters)
                    action_text = hero.decide_action(target)
                    print(action_text)
                    self.combat_log.append(action_text)
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –º–æ–Ω—Å—Ç—Ä —É–±–∏—Ç –∏ –Ω–∞—á–∏—Å–ª—è–µ–º –æ–ø—ã—Ç
                    if not target.is_alive:
                        self.total_exp_earned += target.exp_value
                        kill_message = f"{target.name} –ø–æ–≤–µ—Ä–∂–µ–Ω! +{target.exp_value} –æ–ø—ã—Ç–∞"
                        print(kill_message)
                        self.combat_log.append(kill_message)
                    
                    time.sleep(0.6)  # –ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –¥–µ–π—Å—Ç–≤–∏—è–º–∏
            
            if not any(m.is_alive for m in self.monsters):
                break
                
            # –•–æ–¥ –º–æ–Ω—Å—Ç—Ä–æ–≤
            for monster in self.monsters:
                if monster.is_alive and any(h.is_alive for h in self.heroes):
                    # –ë–æ—Å—Å—ã –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
                    if monster.monster_type == "boss" and random.random() < 0.3:
                        ability_result = monster.use_special_ability(self.heroes)
                        if ability_result:
                            print(ability_result)
                            self.combat_log.append(ability_result)
                            time.sleep(0.8)  # –ù–µ–º–Ω–æ–≥–æ –¥–æ–ª—å—à–µ –¥–ª—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
                            continue
                    
                    alive_heroes = [h for h in self.heroes if h.is_alive]
                    if alive_heroes:
                        target = random.choice(alive_heroes)
                        attack_message = f"{monster.name} –∞—Ç–∞–∫—É–µ—Ç {target.name}!"
                        print(attack_message)
                        self.combat_log.append(attack_message)
                        time.sleep(0.4)
                        
                        result = monster.attack_target(target)
                        print(result)
                        self.combat_log.append(result)
                        time.sleep(0.6)

            round_number += 1
            if round_number > 15:
                timeout_message = "–ë–æ–π –∑–∞—Ç—è–Ω—É–ª—Å—è! –û–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏—Å—Ç–æ—â–µ–Ω—ã..."
                print(timeout_message)
                self.combat_log.append(timeout_message)
                break

        victory = any(h.is_alive for h in self.heroes)
        
        # –í—ã–¥–∞–µ–º –Ω–∞–≥—Ä–∞–¥—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–±–µ–¥–µ
        if victory:
            self._give_victory_rewards()
            
        # –û—á–∏—â–∞–µ–º –≥—Ä—É–ø–ø—ã –æ—Ç –º–µ—Ä—Ç–≤—ã—Ö –≥–µ—Ä–æ–µ–≤
        PartySystem(self.game_state).cleanup_dead_heroes()
        
        # –î–û–ë–ê–í–ò–¢–¨ –ü–†–û–í–ï–†–ö–£ - –æ—á–∏—â–∞–µ–º –º–µ—Ä—Ç–≤—ã—Ö –≥–µ—Ä–æ–µ–≤ —Å —Ä–æ–ª–µ–π, –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ —Ä–æ–ª–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
        if self.game_state.get("role_system") is not None:
            self.game_state["role_system"].cleanup_dead_heroes()
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        self.game_state["save_system"].save_game(self.game_state)

        # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–æ—è –≤ –ª–æ–≥
        result_message = "\nüéâ –ü–û–ë–ï–î–ê!" if victory else "\nüí• –ü–û–†–ê–ñ–ï–ù–ò–ï"
        print(result_message)
        self.combat_log.append(result_message)
        
        self.game_state["tower_monsters"][self.tower_level] = [m.to_dict() for m in self.monsters]
        
        return victory, self.combat_log, self.total_exp_earned

    def cleanup_party_system(self):
        """–û—á–∏—â–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –≥—Ä—É–ø–ø –æ—Ç –º–µ—Ä—Ç–≤—ã—Ö –≥–µ—Ä–æ–µ–≤ –ø–æ—Å–ª–µ –±–æ—è"""
        if "party_system" in self.game_state:
            from systems.party_system import PartySystem
            party_system = PartySystem(self.game_state)
            party_system.cleanup_dead_heroes()

    def _give_victory_rewards(self):
        """–í—ã–¥–∞–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –ø–æ–±–µ–¥—É –Ω–∞ —ç—Ç–∞–∂–µ"""
        from game_data.tower_rewards import get_floor_rewards, generate_item_rewards
        
        rewards = get_floor_rewards(self.tower_level)
        wallet = self.game_state["wallet"]
        storage = self.game_state["storage"]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–æ–ª–æ—Ç–æ –∏ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã
        wallet.add_gold(rewards["gold"])
        wallet.add_crystals(rewards.get("crystals", 0))
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã
        item_rewards = {}
        if "items" in rewards:
            generated_items = generate_item_rewards(rewards["items"])
            for item_id, quantity in generated_items.items():
                item = self.game_state["item_manager"].create_item(item_id, quantity)
                if item and storage.add_item(item):
                    item_rewards[item_id] = quantity
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –Ω–∞–≥—Ä–∞–¥–∞—Ö –¥–ª—è –ø–æ–∫–∞–∑–∞
        self.victory_rewards = {
            "gold": rewards["gold"],
            "crystals": rewards.get("crystals", 0),
            "items": item_rewards
        }